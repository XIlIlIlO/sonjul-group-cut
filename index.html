<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°±í…ŒìŠ¤íŠ¸ í†µí•© í•„í„°ë§ ë„êµ¬ (ìˆ˜ë™ ë‹¤ìš´ë¡œë“œ)</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .container { background: white; padding: 2.5rem; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); width: 100%; max-width: 650px; text-align: center; }
        h2 { margin-bottom: 1.5rem; color: #333; font-weight: 700; }
        .form-group { margin-bottom: 1.2rem; text-align: left; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; }
        
        /* ë©”ì¸ ì‹¤í–‰ ë²„íŠ¼ */
        .btn-main { width: 100%; padding: 15px; color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; background-color: #007bff; transition: 0.3s; }
        .btn-main:hover { background-color: #0056b3; }

        /* ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        #downloadArea { margin-top: 25px; text-align: left; display: none; border-top: 2px solid #eee; padding-top: 20px; }
        .download-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; margin-bottom: 8px; border-radius: 6px; border: 1px solid #e9ecef; }
        .file-name { font-size: 0.9rem; color: #444; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 70%; }
        .btn-download { padding: 6px 12px; background-color: #28a745; color: white; text-decoration: none; border-radius: 4px; font-size: 0.85rem; font-weight: bold; }
        .btn-download:hover { background-color: #218838; }

        .status-msg { margin-top: 1.5rem; font-size: 0.9rem; color: #666; white-space: pre-line; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { font-size: 0.85rem; color: #666; margin-top: 20px; text-align: left; background: #fff4f4; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“Š í†µí•© í•„í„°ë§ (ìˆ˜ë™ ë‹¤ìš´ë¡œë“œí˜•)</h2>
    
    <div class="form-group">
        <label>ì—‘ì…€ íŒŒì¼ë“¤ ì„ íƒ (ë‹¤ì¤‘ ì„ íƒ)</label>
        <input type="file" id="excelFiles" accept=".xlsx" multiple>
    </div>

    <div class="form-group">
        <label>ê¸°ì¤€ ì…ë ¥ (í•©ì‚° níšŒ ì´ìƒ ì†ì ˆ ì‹œ ì œê±°)</label>
        <input type="number" id="nValue" value="1" min="1">
    </div>

    <button class="btn-main" onclick="processFiles()">íŒŒì¼ ë¶„ì„ ì‹œì‘</button>
    
    <div id="statusMsg" class="status-msg">íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ë¶„ì„ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>

    <div id="downloadArea">
        <h3 style="font-size: 1rem; margin-bottom: 15px;">ğŸ“¥ ë¶„ì„ ì™„ë£Œ íŒŒì¼ ëª©ë¡</h3>
        <div id="downloadList"></div>
    </div>

    <div class="info">
        <b>ğŸ’¡ ì‚¬ìš© ë°©ë²•:</b><br>
        1. íŒŒì¼ì„ ì—¬ëŸ¬ ê°œ ì˜¬ë¦¬ê³  ë¶„ì„ ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤.<br>
        2. ë¶„ì„ì´ ëë‚˜ë©´ í•˜ë‹¨ì— <b>íŒŒì¼ë³„ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼</b>ì´ ìƒì„±ë©ë‹ˆë‹¤.<br>
        3. ê° ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ê²°ê³¼ íŒŒì¼ì„ í•˜ë‚˜ì”© ì €ì¥í•˜ì„¸ìš”.
    </div>
</div>

<script>
    function cleanNum(v) {
        if (!v) return 0;
        if (typeof v === 'number') return v;
        return parseFloat(String(v).replace(/[^\d.-]/g, '')) || 0;
    }

    function calcWinRate(win, loss) {
        const total = win + loss;
        return total === 0 ? "0.000%" : ((win / total) * 100).toFixed(3) + "%";
    }

    function applyStyle(ws) {
        ws['!cols'] = [{wch: 22}, {wch: 18}, {wch: 18}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 12}, {wch: 12}, {wch: 15}];
        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let R = range.s.r; R <= range.e.r; ++R) {
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const addr = XLSX.utils.encode_cell({r: R, c: C});
                if (!ws[addr]) continue;
                ws[addr].s = {
                    font: { name: "ë§‘ì€ ê³ ë”•", sz: 10 },
                    alignment: { vertical: "center", horizontal: (C === 0 ? "left" : "right") },
                    border: {
                        top: {style:"thin", color:{rgb:"D3D3D3"}}, bottom: {style:"thin", color:{rgb:"D3D3D3"}},
                        left: {style:"thin", color:{rgb:"D3D3D3"}}, right: {style:"thin", color:{rgb:"D3D3D3"}}
                    }
                };
                if (R === 0 || R === 4) {
                    ws[addr].s.fill = { fgColor: { rgb: "F2F2F2" } };
                    ws[addr].s.font.bold = true;
                    ws[addr].s.alignment.horizontal = "center";
                }
            }
        }
    }

    async function processFiles() {
        const fileInput = document.getElementById('excelFiles');
        const nLimit = parseInt(document.getElementById('nValue').value);
        const status = document.getElementById('statusMsg');
        const downloadArea = document.getElementById('downloadArea');
        const downloadList = document.getElementById('downloadList');

        if (!fileInput.files.length) {
            status.innerHTML = "<span class='error'>íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</span>";
            return;
        }

        // ì´ˆê¸°í™”
        downloadList.innerHTML = "";
        downloadArea.style.display = "none";
        status.innerText = "ë°ì´í„° ë¶„ì„ ì¤‘...";
        
        const files = Array.from(fileInput.files);
        const globalLossMap = {};
        const parsedFiles = [];

        try {
            // 1. ë°ì´í„° íŒŒì‹± ë° ì†ì ˆ íšŸìˆ˜ í•©ì‚°
            for (const file of files) {
                const data = await file.arrayBuffer();
                const wb = XLSX.read(data, {type: 'array'});
                const ws = wb.Sheets[wb.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(ws, {header: 1});
                
                const groupHeaderIdx = rows.findIndex(r => r[0] === "Group Name");
                const groups = rows.slice(groupHeaderIdx + 1).filter(r => r.length > 0);

                groups.forEach(row => {
                    const name = String(row[0]).trim();
                    const lossCnt = cleanNum(row[10]);
                    globalLossMap[name] = (globalLossMap[name] || 0) + lossCnt;
                });
                parsedFiles.push({ name: file.name, rows, groupHeaderIdx });
            }

            // 2. ë¸”ë™ë¦¬ìŠ¤íŠ¸ ìƒì„±
            const blackList = new Set();
            for (const name in globalLossMap) {
                if (globalLossMap[name] >= nLimit) blackList.add(name);
            }

            // 3. íŒŒì¼ ì¬ìƒì„± ë° ë‹¤ìš´ë¡œë“œ ë§í¬ êµ¬ì¶•
            for (const fileObj of parsedFiles) {
                const { name, rows, groupHeaderIdx } = fileObj;
                const groupHeader = rows[groupHeaderIdx];
                const originalGroups = rows.slice(groupHeaderIdx + 1);

                const filtered = originalGroups.filter(row => row.length > 0 && !blackList.has(String(row[0]).trim()));

                let stats = { winAmt:0, lossAmt:0, fee:0, realized:0, unrealized:0, net:0, winCnt:0, lossCnt:0 };
                filtered.forEach(row => {
                    stats.winAmt += cleanNum(row[3]); stats.lossAmt += cleanNum(row[4]);
                    stats.fee += cleanNum(row[5]); stats.realized += cleanNum(row[6]);
                    stats.unrealized += cleanNum(row[7]); stats.net += cleanNum(row[8]);
                    stats.winCnt += cleanNum(row[9]); stats.lossCnt += cleanNum(row[10]);
                });

                const newSummaryRow = [
                    filtered.length, rows[1][1], rows[1][2],
                    stats.winAmt, stats.lossAmt, stats.fee,
                    stats.realized, stats.unrealized, stats.net,
                    stats.winCnt, stats.lossCnt, calcWinRate(stats.winCnt, stats.lossCnt)
                ];

                const finalData = [rows[0], newSummaryRow, [], [], groupHeader, ...filtered];
                const newWs = XLSX.utils.aoa_to_sheet(finalData);
                applyStyle(newWs);
                const newWb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(newWb, newWs, "Filtered");

                // Blob ìƒì„± ë° ë‹¤ìš´ë¡œë“œ ë§í¬ ì¶”ê°€
                const wbOut = XLSX.write(newWb, { bookType: 'xlsx', type: 'binary', cellStyles: true });
                const blob = new Blob([s2ab(wbOut)], { type: "application/octet-stream" });
                const url = URL.createObjectURL(blob);
                
                createDownloadItem(name, url);
            }

            status.innerHTML = `<span class='success'>âœ… ë¶„ì„ ì™„ë£Œ! ì´ ${files.length}ê°œì˜ ê²°ê³¼ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.\n(í•©ì‚° ì†ì ˆ ${nLimit}íšŒ ì´ìƒì¸ ê·¸ë£¹ ${blackList.size}ê°œ ì œê±°ë¨)</span>`;
            downloadArea.style.display = "block";

        } catch (err) {
            console.error(err);
            status.innerHTML = `<span class='error'>ì˜¤ë¥˜ ë°œìƒ: ${err.message}</span>`;
        }
    }

    // íŒŒì¼ ì´ë¦„ê³¼ URLì„ ë°›ì•„ ë‹¤ìš´ë¡œë“œ í–‰ì„ ìƒì„±
    function createDownloadItem(fileName, url) {
        const downloadList = document.getElementById('downloadList');
        const div = document.createElement('div');
        div.className = 'download-item';
        div.innerHTML = `
            <span class="file-name">í•„í„°ì™„ë£Œ_${fileName}</span>
            <a href="${url}" download="í•„í„°ì™„ë£Œ_${fileName}" class="btn-download">ë‹¤ìš´ë¡œë“œ</a>
        `;
        downloadList.appendChild(div);
    }

    // Binary string to ArrayBuffer ë³€í™˜ ìœ í‹¸ë¦¬í‹°
    function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }
</script>

</body>
</html>
