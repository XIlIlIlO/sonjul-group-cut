<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°±í…ŒìŠ¤íŠ¸ í†µí•© í•„í„°ë§ ë„êµ¬ (ìŠ¤íƒ€ì¼ ì™„ë²½ ë°˜ì˜)</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .container { background: white; padding: 2.5rem; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); width: 100%; max-width: 650px; text-align: center; }
        h2 { margin-bottom: 1.5rem; color: #333; font-weight: 700; }
        .form-group { margin-bottom: 1.2rem; text-align: left; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; font-family: inherit; }
        
        .btn-main { width: 100%; padding: 15px; color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; background-color: #007bff; transition: 0.3s; }
        .btn-main:hover { background-color: #0056b3; }

        #downloadArea { margin-top: 25px; text-align: left; display: none; border-top: 2px solid #eee; padding-top: 20px; }
        .download-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; margin-bottom: 8px; border-radius: 8px; border: 1px solid #e9ecef; }
        .file-name { font-size: 0.9rem; color: #444; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 70%; font-weight: 600; }
        .btn-download { padding: 8px 16px; background-color: #28a745; color: white; text-decoration: none; border-radius: 6px; font-size: 0.85rem; font-weight: bold; }
        .btn-download:hover { background-color: #218838; }

        .status-msg { margin-top: 1.5rem; font-size: 0.9rem; color: #666; white-space: pre-line; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { font-size: 0.85rem; color: #666; margin-top: 20px; text-align: left; background: #f0f7ff; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“‘ í†µí•© í•„í„°ë§ ë° ì—‘ì…€ ì¬ì •ë¦¬</h2>
    
    <div class="form-group">
        <label>ì—‘ì…€ íŒŒì¼ë“¤ ì„ íƒ (ë‹¤ì¤‘ ì„ íƒ)</label>
        <input type="file" id="excelFiles" accept=".xlsx" multiple>
    </div>

    <div class="form-group">
        <label>ì œê±° ê¸°ì¤€ (ì „ì²´ íŒŒì¼ í•©ì‚° níšŒ ì´ìƒ ì†ì ˆ ì‹œ ì œê±°)</label>
        <input type="number" id="nValue" value="1" min="1">
    </div>

    <button class="btn-main" onclick="processAllFiles()">ë¶„ì„ ë° ê²°ê³¼ ìƒì„±</button>
    
    <div id="statusMsg" class="status-msg">íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ë¶„ì„ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>

    <div id="downloadArea">
        <h3 style="font-size: 1rem; margin-bottom: 15px; color:#333;">ğŸ“¥ í•„í„°ë§ ì™„ë£Œ íŒŒì¼ ëª©ë¡</h3>
        <div id="downloadList"></div>
    </div>

    <div class="info">
        â€¢ ì§€ì •í•œ <b>níšŒ</b>ëŠ” ëª¨ë“  íŒŒì¼ì—ì„œ í•´ë‹¹ ê·¸ë£¹ëª…ì´ ê¸°ë¡í•œ ì†ì ˆ íšŸìˆ˜ì˜ <b>ì´í•©</b> ê¸°ì¤€ì…ë‹ˆë‹¤.<br>
        â€¢ ì—‘ì…€ì˜ í°íŠ¸, í…Œë‘ë¦¬, ì—´ ë„ˆë¹„ëŠ” ì›ë³¸ í˜•ì‹ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ë©ë‹ˆë‹¤.<br>
        â€¢ í•˜ë‹¨ ëª©ë¡ì—ì„œ ê° íŒŒì¼ì„ í´ë¦­í•˜ì—¬ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.
    </div>
</div>

<script>
    // --- ìš”ì²­í•˜ì‹  ì›ë³¸ ì½”ë“œì˜ ìœ í‹¸ë¦¬í‹° ë° ìŠ¤íƒ€ì¼ë§ í•¨ìˆ˜ ê·¸ëŒ€ë¡œ ë°˜ì˜ ---
    function cleanNumber(valueStr) {
        if (!valueStr) return 0;
        if (typeof valueStr === 'number') return valueStr;
        const cleanStr = String(valueStr).replace(/[^\d.-]/g, '');
        const num = parseFloat(cleanStr);
        return isNaN(num) ? 0 : num;
    }

    function calculateWinRate(winCount, lossCount) {
        if (winCount === 0 && lossCount === 0) return "-";
        const total = winCount + lossCount;
        if (total === 0) return "-";
        return ((winCount / total) * 100).toFixed(3) + "%";
    }

    // ìš”ì²­í•˜ì‹  ì½”ë“œì˜ applyExcelStyle í•¨ìˆ˜ (ìŠ¤íƒ€ì¼ ì™„ë²½ ë™ì¼í™”)
    function applyExcelStyle(ws, headerRowIndex1, headerRowIndex2) {
        ws['!cols'] = [
            {wch: 22}, {wch: 18}, {wch: 18},
            {wch: 17}, {wch: 17}, {wch: 17}, {wch: 17}, {wch: 17}, {wch: 17}, {wch: 17}, {wch: 17}, {wch: 17}
        ];

        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let R = range.s.r; R <= range.e.r; ++R) {
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                if (!ws[cellAddress]) continue;

                let style = {
                    font: { name: "ë§‘ì€ ê³ ë”•", sz: 11 },
                    alignment: { vertical: "center" },
                    border: {
                        top: { style: "thin", color: { rgb: "D3D3D3" } },
                        bottom: { style: "thin", color: { rgb: "D3D3D3" } },
                        left: { style: "thin", color: { rgb: "D3D3D3" } },
                        right: { style: "thin", color: { rgb: "D3D3D3" } }
                    }
                };

                if (R === headerRowIndex1 || R === headerRowIndex2) {
                    style.alignment.horizontal = "center";
                    style.font.bold = true;
                    style.fill = { fgColor: { rgb: "F2F2F2" } };
                } else {
                    if (C === 0) {
                        if (R === headerRowIndex1 + 1) style.alignment.horizontal = "center";
                        else style.alignment.horizontal = "left";
                    } else if (C === 1 || C === 2) {
                        style.alignment.horizontal = "center";
                    } else {
                        style.alignment.horizontal = "right";
                    }
                }
                ws[cellAddress].s = style;
            }
        }
    }

    async function processAllFiles() {
        const fileInput = document.getElementById('excelFiles');
        const nLimit = parseInt(document.getElementById('nValue').value);
        const status = document.getElementById('statusMsg');
        const downloadArea = document.getElementById('downloadArea');
        const downloadList = document.getElementById('downloadList');

        if (!fileInput.files.length) {
            status.innerHTML = "<span class='error'>íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</span>";
            return;
        }

        downloadList.innerHTML = "";
        downloadArea.style.display = "none";
        status.innerText = "í†µí•© ë¶„ì„ ì¤‘...";
        
        const files = Array.from(fileInput.files);
        const globalLossMap = {};
        const parsedFiles = [];

        try {
            // 1. ì „ì—­ ì†ì ˆ íšŸìˆ˜ í•©ì‚° ë¶„ì„
            for (const file of files) {
                const data = await file.arrayBuffer();
                const wb = XLSX.read(data, {type: 'array'});
                const ws = wb.Sheets[wb.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(ws, {header: 1});
                
                const groupHeaderIdx = rows.findIndex(r => r[0] === "Group Name");
                const groups = rows.slice(groupHeaderIdx + 1).filter(r => r.length > 0);

                groups.forEach(row => {
                    const name = String(row[0]).trim();
                    const lossCnt = cleanNumber(row[10]); // ì†ì ˆíšŸìˆ˜ ì¸ë±ìŠ¤
                    globalLossMap[name] = (globalLossMap[name] || 0) + lossCnt;
                });
                parsedFiles.push({ name: file.name, rows, groupHeaderIdx });
            }

            // 2. ë¸”ë™ë¦¬ìŠ¤íŠ¸(ì œê±°ëŒ€ìƒ) ì„ ì •
            const blackList = new Set();
            for (const name in globalLossMap) {
                if (globalLossMap[name] >= nLimit) blackList.add(name);
            }

            // 3. ê°œë³„ íŒŒì¼ í•„í„°ë§ ë° ìŠ¤íƒ€ì¼ ì ìš©í•˜ì—¬ ì¬ìƒì„±
            for (const fileObj of parsedFiles) {
                const { name, rows, groupHeaderIdx } = fileObj;
                const originalGroups = rows.slice(groupHeaderIdx + 1);

                // í†µí•© ê¸°ì¤€ ë¯¸ë‹¬ ê·¸ë£¹ë§Œ í•„í„°ë§
                const filtered = originalGroups.filter(row => row.length > 0 && !blackList.has(String(row[0]).trim()));

                // ìˆ˜ì¹˜ ì¬ê³„ì‚° (ìŠ¹ë¥  í¬í•¨)
                let stats = { winAmt:0, lossAmt:0, fee:0, realized:0, unrealized:0, net:0, winCnt:0, lossCnt:0 };
                filtered.forEach(row => {
                    stats.winAmt += cleanNumber(row[3]); stats.lossAmt += cleanNumber(row[4]);
                    stats.fee += cleanNumber(row[5]); stats.realized += cleanNumber(row[6]);
                    stats.unrealized += cleanNumber(row[7]); stats.net += cleanNumber(row[8]);
                    stats.winCnt += cleanNumber(row[9]); stats.lossCnt += cleanNumber(row[10]);
                });

                const summaryHeader = ["ì „ì²´ ê·¸ë£¹ ìˆ˜", "ì‹œì‘ì¼", "ì¢…ë£Œì¼", "ì´ìµì ˆê¸ˆì•¡", "ì´ì†ì ˆê¸ˆì•¡", "ì´ìˆ˜ìˆ˜ë£Œ", "ì´í™•ì •ì†ìµê¸ˆ", "ì´ë¯¸ì‹¤í˜„ì†ìµ", "ì´ìˆœì´ìµ", "ì´ìµì ˆíšŸìˆ˜", "ì´ì†ì ˆíšŸìˆ˜", "ì „ì²´ìŠ¹ë¥ "];
                const newSummaryRow = [
                    filtered.length, rows[1][1], rows[1][2],
                    stats.winAmt, stats.lossAmt, stats.fee,
                    stats.realized, stats.unrealized, stats.net,
                    stats.winCnt, stats.lossCnt, calculateWinRate(stats.winCnt, stats.lossCnt)
                ];
                const groupHeader = ["Group Name", "ì‹œì‘ì¼", "ì¢…ë£Œì¼", "ìµì ˆê¸ˆì•¡", "ì†ì ˆê¸ˆì•¡", "ìˆ˜ìˆ˜ë£Œ", "í™•ì •ì†ìµê¸ˆ", "ë¯¸ì‹¤í˜„ì†ìµ", "ìˆœì´ìµ", "ìµì ˆíšŸìˆ˜", "ì†ì ˆíšŸìˆ˜", "ìŠ¹ë¥ "];

                // ìµœì¢… ì‹œíŠ¸ ë°ì´í„° êµ¬ì¡° ì¡°ë¦½
                const finalSheetData = [summaryHeader, newSummaryRow, [], [], groupHeader, ...filtered];
                const newWs = XLSX.utils.aoa_to_sheet(finalSheetData);
                
                // ì›ë³¸ ì½”ë“œì˜ ìŠ¤íƒ€ì¼ë§ ì ìš© (ì²«ë²ˆì§¸ í—¤ë”:0í–‰, ë‘ë²ˆì§¸ í—¤ë”:4í–‰)
                applyExcelStyle(newWs, 0, 4);

                const newWb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(newWb, newWs, "Total_Result");

                // Blob ë° URL ìƒì„±
                const wbOut = XLSX.write(newWb, { bookType: 'xlsx', type: 'binary', cellStyles: true });
                const blob = new Blob([s2ab(wbOut)], { type: "application/octet-stream" });
                const url = URL.createObjectURL(blob);
                
                createDownloadLink(name, url);
            }

            status.innerHTML = `<span class='success'>âœ… ë¶„ì„ ì™„ë£Œ! (í•©ì‚° ì†ì ˆ ${nLimit}íšŒ ì´ìƒ ê·¸ë£¹ ${blackList.size}ê°œ ì œê±°ë¨)</span>`;
            downloadArea.style.display = "block";

        } catch (err) {
            console.error(err);
            status.innerHTML = `<span class='error'>ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ${err.message}</span>`;
        }
    }

    function createDownloadLink(fileName, url) {
        const downloadList = document.getElementById('downloadList');
        const div = document.createElement('div');
        div.className = 'download-item';
        div.innerHTML = `
            <span class="file-name">í•„í„°ì™„ë£Œ_${fileName}</span>
            <a href="${url}" download="í•„í„°ì™„ë£Œ_${fileName}" class="btn-download">ë‹¤ìš´ë¡œë“œ</a>
        `;
        downloadList.appendChild(div);
    }

    function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }
</script>

</body>
</html>
