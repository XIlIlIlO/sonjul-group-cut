<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°±í…ŒìŠ¤íŠ¸ í†µí•© í•„í„°ë§ ë„êµ¬</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .container { background: white; padding: 2.5rem; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); width: 100%; max-width: 600px; text-align: center; }
        h2 { margin-bottom: 1.5rem; color: #333; font-weight: 700; }
        .form-group { margin-bottom: 1.2rem; text-align: left; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; }
        button { width: 100%; padding: 15px; color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; background-color: #007bff; transition: 0.3s; }
        button:hover { background-color: #0056b3; }
        .status-msg { margin-top: 1.5rem; font-size: 0.9rem; color: #666; white-space: pre-line; text-align: left; }
        .info { font-size: 0.85rem; color: #666; margin-top: 20px; text-align: left; background: #fff4f4; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“Š ë‹¤ì¤‘ íŒŒì¼ í†µí•© í•„í„°ë§</h2>
    
    <div class="form-group">
        <label>ì—‘ì…€ íŒŒì¼ë“¤ ì„ íƒ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</label>
        <input type="file" id="excelFiles" accept=".xlsx" multiple>
    </div>

    <div class="form-group">
        <label>ê¸°ì¤€ ì…ë ¥ (ì „ì²´ íŒŒì¼ í•©ì‚° níšŒ ì´ìƒ ì†ì ˆ ì‹œ ì œê±°)</label>
        <input type="number" id="nValue" value="1" min="1">
    </div>

    <button onclick="processMultipleFiles()">í†µí•© ë¶„ì„ ë° ê°œë³„ ë‹¤ìš´ë¡œë“œ</button>
    
    <div id="statusMsg" class="status-msg">íŒŒì¼ë“¤ì„ ì—…ë¡œë“œí•˜ë©´ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.</div>

    <div class="info">
        <b>âš ï¸ ì£¼ì˜ì‚¬í•­:</b><br>
        1. ëª¨ë“  íŒŒì¼ì—ì„œ ë™ì¼í•œ <b>Group Name</b>ì„ ì°¾ì•„ ì†ì ˆ íšŸìˆ˜ë¥¼ í•©ì‚°í•©ë‹ˆë‹¤.<br>
        2. í•©ì‚° ê²°ê³¼ê°€ ê¸°ì¤€ì¹˜ ì´ìƒì¸ ê·¸ë£¹ì€ <b>ëª¨ë“  íŒŒì¼ì—ì„œ ì œì™¸</b>ë©ë‹ˆë‹¤.<br>
        3. ë¸Œë¼ìš°ì € ì„¤ì •ì— ë”°ë¼ <b>ì—¬ëŸ¬ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ê¶Œí•œ</b> í—ˆìš©ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>
</div>

<script>
    function cleanNum(v) {
        if (!v) return 0;
        if (typeof v === 'number') return v;
        return parseFloat(String(v).replace(/[^\d.-]/g, '')) || 0;
    }

    function calcWinRate(win, loss) {
        const total = win + loss;
        if (total === 0) return "0.000%";
        return ((win / total) * 100).toFixed(3) + "%";
    }

    // ì—‘ì…€ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ í˜•ì‹ ìœ ì§€)
    function applyStyle(ws) {
        ws['!cols'] = [{wch: 22}, {wch: 18}, {wch: 18}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 12}, {wch: 12}, {wch: 15}];
        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let R = range.s.r; R <= range.e.r; ++R) {
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const addr = XLSX.utils.encode_cell({r: R, c: C});
                if (!ws[addr]) continue;
                ws[addr].s = {
                    font: { name: "ë§‘ì€ ê³ ë”•", sz: 10 },
                    alignment: { vertical: "center", horizontal: (C === 0 ? "left" : "right") },
                    border: {
                        top: {style:"thin", color:{rgb:"D3D3D3"}}, bottom: {style:"thin", color:{rgb:"D3D3D3"}},
                        left: {style:"thin", color:{rgb:"D3D3D3"}}, right: {style:"thin", color:{rgb:"D3D3D3"}}
                    }
                };
                if (R === 0 || R === 4) {
                    ws[addr].s.fill = { fgColor: { rgb: "F2F2F2" } };
                    ws[addr].s.font.bold = true;
                    ws[addr].s.alignment.horizontal = "center";
                }
            }
        }
    }

    async function processMultipleFiles() {
        const fileInput = document.getElementById('excelFiles');
        const nLimit = parseInt(document.getElementById('nValue').value);
        const status = document.getElementById('statusMsg');

        if (!fileInput.files.length) {
            status.innerHTML = "<span class='error'>íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</span>";
            return;
        }

        status.innerText = "1ë‹¨ê³„: ëª¨ë“  íŒŒì¼ ë°ì´í„° í†µí•© ë¶„ì„ ì¤‘...";
        
        const files = Array.from(fileInput.files);
        const allFileData = [];
        const globalLossMap = {}; // GroupNameë³„ ëˆ„ì  ì†ì ˆ íšŸìˆ˜ ì €ì¥

        try {
            // 1. ëª¨ë“  íŒŒì¼ ì½ê¸° ë° ì „ì—­ ì†ì ˆ íšŸìˆ˜ í•©ì‚°
            for (const file of files) {
                const data = await file.arrayBuffer();
                const wb = XLSX.read(data, {type: 'array'});
                const ws = wb.Sheets[wb.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(ws, {header: 1});
                
                const groupHeaderIdx = rows.findIndex(r => r[0] === "Group Name");
                const groups = rows.slice(groupHeaderIdx + 1).filter(r => r.length > 0);

                groups.forEach(row => {
                    const name = String(row[0]).trim();
                    const lossCnt = cleanNum(row[10]); // ì†ì ˆíšŸìˆ˜ ì¸ë±ìŠ¤
                    globalLossMap[name] = (globalLossMap[name] || 0) + lossCnt;
                });

                allFileData.push({ name: file.name, rows, groupHeaderIdx });
            }

            // 2. ì œì™¸ ëŒ€ìƒ ê·¸ë£¹ ì„ ë³„
            const blackList = new Set();
            for (const name in globalLossMap) {
                if (globalLossMap[name] >= nLimit) {
                    blackList.add(name);
                }
            }

            status.innerText = `2ë‹¨ê³„: í•„í„°ë§ ì ìš© ë° íŒŒì¼ ìƒì„± ì¤‘... (ì œì™¸ ê·¸ë£¹: ${blackList.size}ê°œ)`;

            // 3. íŒŒì¼ë³„ í•„í„°ë§, ì¬ê³„ì‚° ë° ë‹¤ìš´ë¡œë“œ
            for (const fileObj of allFileData) {
                const { name, rows, groupHeaderIdx } = fileObj;
                const groupHeader = rows[groupHeaderIdx];
                const originalGroups = rows.slice(groupHeaderIdx + 1);

                // í†µí•© ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ì—†ëŠ” ê·¸ë£¹ë§Œ í•„í„°ë§
                const filtered = originalGroups.filter(row => row.length > 0 && !blackList.has(String(row[0]).trim()));

                // ìˆ˜ì¹˜ ì¬ê³„ì‚°
                let stats = { winAmt:0, lossAmt:0, fee:0, realized:0, unrealized:0, net:0, winCnt:0, lossCnt:0 };
                filtered.forEach(row => {
                    stats.winAmt += cleanNum(row[3]); stats.lossAmt += cleanNum(row[4]);
                    stats.fee += cleanNum(row[5]); stats.realized += cleanNum(row[6]);
                    stats.unrealized += cleanNum(row[7]); stats.net += cleanNum(row[8]);
                    stats.winCnt += cleanNum(row[9]); stats.lossCnt += cleanNum(row[10]);
                });

                const newSummaryRow = [
                    filtered.length, rows[1][1], rows[1][2],
                    stats.winAmt, stats.lossAmt, stats.fee,
                    stats.realized, stats.unrealized, stats.net,
                    stats.winCnt, stats.lossCnt, calcWinRate(stats.winCnt, stats.lossCnt)
                ];

                const finalData = [rows[0], newSummaryRow, [], [], groupHeader, ...filtered];
                const newWs = XLSX.utils.aoa_to_sheet(finalData);
                applyStyle(newWs);
                const newWb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(newWb, newWs, "Filtered");

                // íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
                XLSX.writeFile(newWb, `í•„í„°ì™„ë£Œ_${name}`);
            }

            status.innerHTML = `<span class='success'>âœ… ëª¨ë“  ì²˜ë¦¬ ì™„ë£Œ!\nì´ ${files.length}ê°œì˜ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.\n(í•©ì‚° ì†ì ˆ ${nLimit}íšŒ ì´ìƒì¸ ê·¸ë£¹ ${blackList.size}ê°œ ì¼ê´„ ì œê±°ë¨)</span>`;

        } catch (err) {
            console.error(err);
            status.innerHTML = `<span class='error'>ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${err.message}</span>`;
        }
    }
</script>

</body>
</html>
