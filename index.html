<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼ í•„í„°ë§ ë„êµ¬</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            background: white;
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        h2 { margin-bottom: 1.5rem; color: #333; font-weight: 700; font-size: 1.5rem; }
        
        .form-group { margin-bottom: 1.2rem; text-align: left; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555; }
        
        input[type="number"], input[type="file"] {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
            box-sizing: border-box; font-family: 'Malgun Gothic', sans-serif; background-color: #fcfcfc;
        }

        .btn-container { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }

        button {
            width: 100%; padding: 14px; color: white; border: none; border-radius: 8px;
            font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: background 0.3s;
            font-family: 'Malgun Gothic', sans-serif;
        }
        
        .btn-filter { background-color: #dc3545; }
        .btn-filter:hover { background-color: #a71d2a; }

        .status-msg { margin-top: 1.5rem; font-size: 0.9rem; color: #666; min-height: 20px; }
        .success { color: #28a745 !important; font-weight: bold; }
        .error { color: #dc3545 !important; font-weight: bold; }

        .info-text {
            font-size: 0.85rem; color: #888; margin-top: 10px; line-height: 1.4;
            text-align: left; background: #f8f9fa; padding: 10px; border-radius: 8px;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ¯ ì†ì ˆ ê·¸ë£¹ í•„í„°ë§ ë„êµ¬</h2>
    
    <div class="form-group">
        <label for="excelFile">ê²°ê³¼ ì—‘ì…€ íŒŒì¼ ì„ íƒ (.xlsx)</label>
        <input type="file" id="excelFile" accept=".xlsx">
    </div>

    <div class="form-group">
        <label for="nValue">í•„í„°ë§ ê¸°ì¤€ (níšŒ ì´ìƒ ì†ì ˆ ì‹œ ì œê±°)</label>
        <input type="number" id="nValue" value="1" min="1">
    </div>

    <div class="btn-container">
        <button class="btn-filter" onclick="filterAndRebuild()">í•„í„°ë§ ë° ì¬ì •ë¦¬ ë‹¤ìš´ë¡œë“œ</button>
    </div>
    
    <div id="statusMsg" class="status-msg">íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ê¸°ì¤€ ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.</div>

    <div class="info-text">
        â€¢ <b>ì‘ë™ ì›ë¦¬:</b> í•˜ë‹¨ ê°œë³„ ê·¸ë£¹ ì¤‘ 'ì†ì ˆíšŸìˆ˜'ê°€ níšŒ ì´ìƒì¸ ê·¸ë£¹ì„ ì‚­ì œí•©ë‹ˆë‹¤.<br>
        â€¢ <b>ìë™ ê³„ì‚°:</b> ë‚¨ì€ ê·¸ë£¹ë“¤ì„ í•©ì‚°í•˜ì—¬ ìƒë‹¨ì˜ 'ì´ìµì ˆê¸ˆì•¡', 'ì „ì²´ìŠ¹ë¥ ' ë“± ìš”ì•½ ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ ê°±ì‹ í•©ë‹ˆë‹¤.
    </div>
</div>

<script>
    // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
    function cleanNumber(val) {
        if (!val) return 0;
        if (typeof val === 'number') return val;
        return parseFloat(String(val).replace(/[^\d.-]/g, '')) || 0;
    }

    function calculateWinRate(win, loss) {
        const total = win + loss;
        return total === 0 ? "0.000%" : ((win / total) * 100).toFixed(3) + "%";
    }

    // ìŠ¤íƒ€ì¼ ì ìš© (ê¸°ì¡´ ì½”ë“œì˜ ìŠ¤íƒ€ì¼ ë¡œì§ í™œìš©)
    function applyStyle(ws) {
        ws['!cols'] = [{wch: 22}, {wch: 18}, {wch: 18}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 12}, {wch: 12}, {wch: 15}];
        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let R = range.s.r; R <= range.e.r; ++R) {
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const addr = XLSX.utils.encode_cell({r: R, c: C});
                if (!ws[addr]) continue;
                ws[addr].s = {
                    font: { name: "ë§‘ì€ ê³ ë”•", sz: 10 },
                    alignment: { vertical: "center", horizontal: (C === 0 ? "left" : "right") },
                    border: {
                        top: {style:"thin", color:{rgb:"D3D3D3"}}, bottom: {style:"thin", color:{rgb:"D3D3D3"}},
                        left: {style:"thin", color:{rgb:"D3D3D3"}}, right: {style:"thin", color:{rgb:"D3D3D3"}}
                    }
                };
                if (R === 0 || R === 4) { // í—¤ë”í–‰
                    ws[addr].s.fill = { fgColor: { rgb: "F2F2F2" } };
                    ws[addr].s.font.bold = true;
                    ws[addr].s.alignment.horizontal = "center";
                }
            }
        }
    }

    async function filterAndRebuild() {
        const fileInput = document.getElementById('excelFile');
        const nInput = document.getElementById('nValue');
        const statusDiv = document.getElementById('statusMsg');

        if (!fileInput.files.length) {
            statusDiv.innerHTML = "<span class='error'>íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</span>";
            return;
        }

        const nLimit = parseInt(nInput.value);
        const file = fileInput.files[0];
        statusDiv.innerText = "ë°ì´í„° ë¶„ì„ ì¤‘...";

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const ws = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(ws, {header: 1});

                if (jsonData.length < 6) {
                    throw new Error("ì—‘ì…€ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                }

                // 1. ë°ì´í„° ë¶„ë¦¬
                // 0: ì „ì²´í—¤ë”, 1: ì „ì²´ë°ì´í„°, 2-3: ê³µë°±, 4: ê·¸ë£¹í—¤ë”, 5~: ê·¸ë£¹ë°ì´í„°
                const groupHeader = jsonData[4];
                const rawGroups = jsonData.slice(5);

                // 2. í•„í„°ë§ (ì†ì ˆíšŸìˆ˜ëŠ” ë³´í†µ 10ë²ˆì§¸ ì¸ë±ìŠ¤ - 'ì†ì ˆíšŸìˆ˜')
                const lossIdx = groupHeader.indexOf("ì†ì ˆíšŸìˆ˜");
                if (lossIdx === -1) throw new Error("'ì†ì ˆíšŸìˆ˜' ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

                const filteredGroups = rawGroups.filter(row => {
                    if (!row || row.length === 0) return false;
                    return cleanNumber(row[lossIdx]) < nLimit;
                });

                // 3. ì „ì²´ í†µê³„ ì¬ê³„ì‚°
                let totalStats = {
                    winAmt: 0, lossAmt: 0, fee: 0, realized: 0, unrealized: 0, net: 0, winCnt: 0, lossCnt: 0
                };

                filteredGroups.forEach(g => {
                    totalStats.winAmt += cleanNumber(g[3]); // ìµì ˆê¸ˆì•¡
                    totalStats.lossAmt += cleanNumber(g[4]); // ì†ì ˆê¸ˆì•¡
                    totalStats.fee += cleanNumber(g[5]); // ìˆ˜ìˆ˜ë£Œ
                    totalStats.realized += cleanNumber(g[6]); // í™•ì •ì†ìµ
                    totalStats.unrealized += cleanNumber(g[7]); // ë¯¸ì‹¤í˜„
                    totalStats.net += cleanNumber(g[8]); // ìˆœì´ìµ
                    totalStats.winCnt += cleanNumber(g[9]); // ìµì ˆíšŸìˆ˜
                    totalStats.lossCnt += cleanNumber(g[10]); // ì†ì ˆíšŸìˆ˜
                });

                // 4. ìƒˆ ì—‘ì…€ ë°ì´í„° êµ¬ì„±
                const newTotalRow = [
                    filteredGroups.length, jsonData[1][1], jsonData[1][2], // ê·¸ë£¹ìˆ˜, ì‹œì‘ì¼, ì¢…ë£Œì¼
                    totalStats.winAmt, totalStats.lossAmt, totalStats.fee,
                    totalStats.realized, totalStats.unrealized, totalStats.net,
                    totalStats.winCnt, totalStats.lossCnt, calculateWinRate(totalStats.winCnt, totalStats.lossCnt)
                ];

                const finalData = [
                    jsonData[0], // ìƒë‹¨ í—¤ë”
                    newTotalRow,
                    [], [],      // ê³µë°±
                    groupHeader, // ê·¸ë£¹ í—¤ë”
                    ...filteredGroups
                ];

                // 5. íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
                const newWs = XLSX.utils.aoa_to_sheet(finalData);
                applyStyle(newWs);
                const newWb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(newWb, newWs, "Filtered_Result");
                
                const fileName = `í•„í„°ë§_ê²°ê³¼_n${nLimit}ë¯¸ë§Œ.xlsx`;
                XLSX.writeFile(newWb, fileName);

                statusDiv.innerHTML = `<span class='success'>âœ… í•„í„°ë§ ì™„ë£Œ! (ë‚¨ì€ ê·¸ë£¹: ${filteredGroups.length}ê°œ)</span>`;

            } catch (err) {
                console.error(err);
                statusDiv.innerHTML = `<span class='error'>ì˜¤ë¥˜: ${err.message}</span>`;
            }
        };
        reader.readAsArrayBuffer(file);
    }
</script>

</body>
</html>
